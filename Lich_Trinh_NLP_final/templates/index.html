<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Lá»‹ch thÃ´ng minh</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
</head>
<body>

    <div id="reminder-popup-container"></div>

    <h2>â• ThÃªm Sá»± Kiá»‡n qua AI</h2>

    <form action="/add" method="POST">
        <input type="text" name="event_text" placeholder="VÃ­ dá»¥: Há»p lÃºc 10h30 20/12/2025" style="width: 300px;">
        <button>ThÃªm</button>
    </form>

    <hr>

    <h2>ğŸ—“ï¸ Lá»‹ch Sá»± Kiá»‡n</h2>

    <div class="list-group">
        <a href="{{ url_for('list_all') }}" class="list-button">ğŸ“ Xem Danh SÃ¡ch Tá»•ng Há»£p</a>
    </div>

    <div id="calendar-container">
        <div id="calendar"></div>
    </div>

    <div class="export-group">
        <a href="{{ url_for('export_json') }}" class="export-button json-button">ğŸ“¥ Xuáº¥t dá»¯ liá»‡u (.json)</a>
        <a href="{{ url_for('export_ics') }}" class="export-button ics-button">icalendar (.ics)</a>
    </div>

    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/vi.js'></script>

    <script>

        // --- LOGIC FULLCALENDAR ---
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'vi',
                height: 'auto',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },

                events: '{{ url_for("events_feed") }}',

                eventClick: function(info) {
                    if (info.event.url) {
                        info.jsEvent.preventDefault();
                        window.location.href = info.event.url;
                    }
                },

                eventColor: '#007bff'
            });
            calendar.render();
        });


        // --- LOGIC AJAX POLLING VÃ€ POP-UP ---
        const POLLING_INTERVAL = 10000;
        const SEEN_REMINDERS_KEY = 'seenReminders';

        function getSeenReminders() {
            try {
                const stored = localStorage.getItem(SEEN_REMINDERS_KEY);
                return stored ? JSON.parse(stored) : {};
            } catch (e) {
                console.error("Lá»—i khi Ä‘á»c localStorage:", e);
                return {};
            }
        }

        function markAsSeen(eventId) {
            const seenReminders = getSeenReminders();
            seenReminders[eventId] = Date.now();
            try {
                localStorage.setItem(SEEN_REMINDERS_KEY, JSON.stringify(seenReminders));
            } catch (e) {
                console.error("Lá»—i khi ghi localStorage:", e);
            }

            const popup = document.getElementById('popup-' + eventId);
            if (popup) {
                popup.style.display = 'none';
            }
        }

        function fetchReminders() {
            const seenReminders = getSeenReminders();

            fetch('{{ url_for("api_check_reminders") }}')
                .then(response => response.json())
                .then(reminders => {
                    const container = document.getElementById('reminder-popup-container');
                    container.innerHTML = '';

                    reminders.forEach(r => {
                        const eventId = r.id.toString();

                        if (!seenReminders.hasOwnProperty(eventId)) {
                            const startTime = r.start.split('T')[1].substring(0, 5);

                            const listContent = `<li><strong>${r.name}</strong> (Báº¯t Ä‘áº§u: ${startTime} | Nháº¯c lÃºc: ${r.reminder_time})</li>`;

                            const popupHTML = `
                                <div class="reminder-popup" id="popup-${eventId}">
                                    <h3>ğŸ”” Nháº¯c nhá»Ÿ Lá»‹ch trÃ¬nh!</h3>
                                    <ul>${listContent}</ul>
                                    <button class="close-popup" onclick="markAsSeen(${eventId})">ÄÃ³ng thÃ´ng bÃ¡o</button>
                                </div>
                            `;

                            container.innerHTML += popupHTML;
                        }
                    });
                })
                .catch(error => console.error('Lá»—i khi táº£i nháº¯c nhá»Ÿ:', error));
        }

        fetchReminders();
        setInterval(fetchReminders, POLLING_INTERVAL);
    </script>
</body>
</html>